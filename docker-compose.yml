version: "3.8"

services:
  # Development environment
  red-magic-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
      args:
        - NPM_TOKEN=${NPM_TOKEN:-}
    ports:
      - "3000:3000"
    volumes:
      - .:/usr/src/app
      - /usr/src/app/node_modules
    environment:
      - NODE_ENV=development
      - NODE_CONFIG_ENV=dev
      - NEXT_PUBLIC_BACKEND_URL=${NEXT_PUBLIC_BACKEND_URL:-}
      - NEXT_PUBLIC_CRM_BACKEND_URL=${NEXT_PUBLIC_CRM_BACKEND_URL:-}
      - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL:-}
      - NEXT_PUBLIC_MINIO_BUCKET=${NEXT_PUBLIC_MINIO_BUCKET:-}
      - NEXT_PUBLIC_MINIO_ENDPOINT=${NEXT_PUBLIC_MINIO_ENDPOINT:-}
      - NEXT_PUBLIC_MINIO_ID=${NEXT_PUBLIC_MINIO_ID:-}
      - NEXT_PUBLIC_MINIO_KEY=${NEXT_PUBLIC_MINIO_KEY:-}
      - NEXT_PUBLIC_CDN_URL=${NEXT_PUBLIC_CDN_URL:-}
      - NEXT_PUBLIC_DISABLE_SSE=${NEXT_PUBLIC_DISABLE_SSE:-}
      - NEXT_PUBLIC_MAINTENANCE_MODE=${NEXT_PUBLIC_MAINTENANCE_MODE:-}
      - NEXT_PUBLIC_WHITE_WALKER_SOCKET_URL=${NEXT_PUBLIC_WHITE_WALKER_SOCKET_URL:-}
    command: yarn dev --turbopack
    networks:
      - red-magic-network

  # Staging environment
  red-magic-stage:
    build:
      context: .
      dockerfile: Dockerfile
      target: stage
      args:
        - NPM_TOKEN=${NPM_TOKEN:-}
        - NEXT_PUBLIC_BACKEND_URL=${NEXT_PUBLIC_BACKEND_URL:-}
        - NEXT_PUBLIC_CRM_BACKEND_URL=${NEXT_PUBLIC_CRM_BACKEND_URL:-}
        - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL:-}
        - NEXT_PUBLIC_MINIO_BUCKET=${NEXT_PUBLIC_MINIO_BUCKET:-}
        - NEXT_PUBLIC_MINIO_ENDPOINT=${NEXT_PUBLIC_MINIO_ENDPOINT:-}
        - NEXT_PUBLIC_MINIO_ID=${NEXT_PUBLIC_MINIO_ID:-}
        - NEXT_PUBLIC_MINIO_KEY=${NEXT_PUBLIC_MINIO_KEY:-}
        - NEXT_PUBLIC_CDN_URL=${NEXT_PUBLIC_CDN_URL:-}
        - NEXT_PUBLIC_DISABLE_SSE=${NEXT_PUBLIC_DISABLE_SSE:-}
        - NEXT_PUBLIC_MAINTENANCE_MODE=${NEXT_PUBLIC_MAINTENANCE_MODE:-}
        - NEXT_PUBLIC_WHITE_WALKER_SOCKET_URL=${NEXT_PUBLIC_WHITE_WALKER_SOCKET_URL:-}
    ports:
      - "3001:3000"
    environment:
      - NODE_ENV=production
      - NODE_CONFIG_ENV=stage
    networks:
      - red-magic-network

  # Production environment
  red-magic-prod:
    build:
      context: .
      dockerfile: Dockerfile
      target: prod
      args:
        - NPM_TOKEN=${NPM_TOKEN:-}
        - NEXT_PUBLIC_BACKEND_URL=${NEXT_PUBLIC_BACKEND_URL:-}
        - NEXT_PUBLIC_CRM_BACKEND_URL=${NEXT_PUBLIC_CRM_BACKEND_URL:-}
        - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL:-}
        - NEXT_PUBLIC_MINIO_BUCKET=${NEXT_PUBLIC_MINIO_BUCKET:-}
        - NEXT_PUBLIC_MINIO_ENDPOINT=${NEXT_PUBLIC_MINIO_ENDPOINT:-}
        - NEXT_PUBLIC_MINIO_ID=${NEXT_PUBLIC_MINIO_ID:-}
        - NEXT_PUBLIC_MINIO_KEY=${NEXT_PUBLIC_MINIO_KEY:-}
        - NEXT_PUBLIC_CDN_URL=${NEXT_PUBLIC_CDN_URL:-}
        - NEXT_PUBLIC_DISABLE_SSE=${NEXT_PUBLIC_DISABLE_SSE:-}
        - NEXT_PUBLIC_MAINTENANCE_MODE=${NEXT_PUBLIC_MAINTENANCE_MODE:-}
        - NEXT_PUBLIC_WHITE_WALKER_SOCKET_URL=${NEXT_PUBLIC_WHITE_WALKER_SOCKET_URL:-}
    ports:
      - "3002:3000"
    environment:
      - NODE_ENV=production
      - NODE_CONFIG_ENV=production
    networks:
      - red-magic-network

networks:
  red-magic-network:
    driver: bridge
